---
import Button from "./ui/button.astro";
import Container from "./container.astro";
---

<div class="bg-emerald-50 py-16 mt-24">
  <Container>
    <div class="max-w-3xl mx-auto text-center">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">
        Stay Updated
      </h2>
      <p class="text-lg text-gray-600 mb-8">
        Subscribe to our newsletter for the latest insights on technology consulting, digital transformation, and industry trends.
      </p>

      <form
        id="newsletter-form"
        class="needs-validation max-w-md mx-auto"
        novalidate>
        <input type="checkbox" class="hidden" style="display:none" name="botcheck" />

        <div class="flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label for="newsletter_email" class="sr-only">Email Address</label>
            <input
              id="newsletter_email"
              type="email"
              placeholder="Enter your email"
              name="email"
              required
              class="w-full px-4 py-3 border-2 placeholder:text-gray-600 rounded-md outline-hidden focus:ring-4 border-gray-300 focus:border-emerald-600 ring-emerald-100"
            />
            <div class="empty-feedback text-red-500 text-sm mt-1 text-left">
              Please provide your email address.
            </div>
            <div class="invalid-feedback text-red-500 text-sm mt-1 text-left">
              Please provide a valid email address.
            </div>
          </div>
          <div>
            <Button type="submit" size="lg" class="w-full sm:w-auto">
              Subscribe
            </Button>
          </div>
        </div>

        <div id="newsletter-result" class="mt-3 text-sm"></div>
      </form>
    </div>
  </Container>
</div>

<style>
  .invalid-feedback,
  .empty-feedback {
    display: none;
  }

  .was-validated :placeholder-shown:invalid ~ .empty-feedback {
    display: block;
  }

  .was-validated :not(:placeholder-shown):invalid ~ .invalid-feedback {
    display: block;
  }

  .is-invalid,
  .was-validated :invalid {
    border-color: #dc3545;
  }
</style>

<script is:inline>
  document.addEventListener(
    "astro:page-load",
    () => {
      const form = document.getElementById("newsletter-form");
      const result = document.getElementById("newsletter-result");

      if (!form || !result) return;

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        form.classList.add("was-validated");

        if (!form.checkValidity()) {
          form.querySelectorAll(":invalid")[0]?.focus();
          return;
        }

        const formData = new FormData(form);
        const email = formData.get("email");

        result.textContent = "Subscribing...";
        result.className = "mt-3 text-sm text-gray-600";

        try {
          const response = await fetch("/api/newsletter", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            result.className = "mt-3 text-sm text-green-600 font-medium";
            result.textContent = data.message;
            form.reset();
            form.classList.remove("was-validated");
          } else {
            result.className = "mt-3 text-sm text-red-500";
            result.textContent = data.message;
          }
        } catch (error) {
          console.error(error);
          result.className = "mt-3 text-sm text-red-500";
          result.textContent = "Something went wrong. Please try again.";
        }

        setTimeout(() => {
          result.style.display = "none";
        }, 5000);
      });
    },
    { once: true }
  );
</script>
